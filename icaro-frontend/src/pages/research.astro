---
import BaseLayout from "@/layouts/BaseLayout.astro";
import TopUtility from "@/components/TopUtility.astro";
import NavBar from "@/components/NavBar.astro";
import Header from "@/components/Header.astro";
import YearGroup from "@/components/YearGroup.astro";

const res = await fetch("http://localhost:8080/api/works/all");
const works = await res.json();

const groupsObj = {};
works.forEach(work => {
  const year = work.projectDate?.slice(0, 4) || "Sin fecha";
  if (!groupsObj[year]) groupsObj[year] = [];
  groupsObj[year].push(work);
});

const noDateItems = groupsObj["Sin fecha"] || [];
delete groupsObj["Sin fecha"];

const researchGroups = Object.entries(groupsObj)
  .map(([year, items]) => ({ year, items }))
  .sort((a, b) =>
    b.year.localeCompare(a.year, undefined, { numeric: true })
  );

if (noDateItems.length) {
  researchGroups.push({ year: "Sin fecha", items: noDateItems });
}
---
<BaseLayout>
  <section class="max-w-full bg-white shadow-md rounded-lg">
    <TopUtility />
    <Header />
  </section>
  <section class="mt-10 max-w-full bg-white shadow-md">
    <NavBar />
  </section>

  <section
    class="w-full content-wrap bg-white shadow-md
           max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 mt-10"
  >
    <div class="mb-8 relative inline-block w-full text-center py-2">
      <h2 class="text-2xl font-bold text-[#231F20]">Investigaci√≥n</h2>
      <span
        class="absolute left-1/2 bottom-0 w-20 h-1 bg-[#006D38]
               -translate-x-1/2"
      ></span>
    </div>

    {researchGroups.map(group => (
      <YearGroup group={group} />
    ))}
  </section>
</BaseLayout>
