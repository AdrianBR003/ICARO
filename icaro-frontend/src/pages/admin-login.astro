---
import BaseLayout from "@/layouts/BaseLayout.astro";
import "@/styles/index.css";
---

<BaseLayout>
    <div
        class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 flex items-center justify-center p-4"
    >
        <div class="w-full max-w-md">
            <div class="text-center mb-8">
                <div
                    class="bg-white rounded-full w-20 h-20 mx-auto mb-4 flex items-center justify-center shadow-lg"
                >
                    <svg
                        class="w-10 h-10 text-[#2c3e50]"
                        fill="currentColor"
                        viewBox="0 0 20 20"
                    >
                        <path
                            fill-rule="evenodd"
                            d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z"
                            clip-rule="evenodd"></path>
                    </svg>
                </div>
                <h1 class="text-2xl font-bold text-[#2c3e50] mb-2">
                    Panel de Administración
                </h1>
                <p class="text-slate-600">Grupo de Investigación TST</p>
            </div>

            <div
                class="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden"
            >
                <div
                    class="bg-gradient-to-r from-[#2c3e50] to-[#34495e] px-6 py-4"
                >
                    <h2 class="text-white font-semibold text-center">
                        Iniciar Sesión
                    </h2>
                </div>

                <div class="p-6">
                    <form id="loginForm" class="space-y-5">
                        <div>
                            <label
                                for="username"
                                class="block text-sm font-medium text-slate-700 mb-2"
                            >
                                Usuario
                            </label>
                            <input
                                type="text"
                                id="username"
                                name="username"
                                required
                                class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-[#2c3e50] focus:border-transparent transition-all duration-200 bg-slate-50"
                                placeholder="Ingrese su usuario"
                            />
                        </div>

                        <div>
                            <label
                                for="password"
                                class="block text-sm font-medium text-slate-700 mb-2"
                            >
                                Contraseña
                            </label>
                            <input
                                type="password"
                                id="password"
                                name="password"
                                required
                                class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-[#2c3e50] focus:border-transparent transition-all duration-200 bg-slate-50"
                                placeholder="Ingrese su contraseña"
                            />
                        </div>

                        <div class="flex justify-center">
                            <button
                                type="submit"
                                id="loginButton"
                                class="w-auto bg-gradient-to-r from-[#2c3e50] to-[#34495e] hover:from-[#34495e] hover:to-[#2c3e50] text-white font-semibold py-3 px-6 rounded-lg transition-all duration-200 focus:ring-2 focus:ring-[#2c3e50] focus:ring-opacity-50"
                            >
                                Confirmar
                            </button>
                        </div>
                    </form>

                    <!-- Message Area -->
                    <div
                        id="message"
                        class="mt-4 p-3 rounded-lg text-sm text-center hidden"
                    >
                    </div>
                </div>

                <!-- Footer -->
                <div class="bg-slate-50 px-6 py-3 text-center">
                    <p class="text-xs text-slate-500">
                        Universidad de Jaén - Sistema de Administración
                    </p>
                </div>
            </div>

            <!-- Back to site link -->
            <div class="text-center mt-6">
                <a
                    href="/"
                    class="text-slate-600 hover:text-[#2c3e50] text-sm transition-colors duration-200"
                >
                    ← Volver al sitio web
                </a>
            </div>
        </div>
    </div>

    <style>
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .message.success {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .message.error {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        /* Custom focus styles */
        input:focus {
            box-shadow: 0 0 0 3px rgba(44, 62, 80, 0.1);
        }

        button:focus {
            box-shadow: 0 0 0 3px rgba(44, 62, 80, 0.3);
        }
    </style>

    <script is:inline>
        document.addEventListener("DOMContentLoaded", () => {
            const API_BASE = "http://localhost:8080/api";

            const loginForm = document.getElementById("loginForm");
            const loginButton = document.getElementById("loginButton");
            const messageDiv = document.getElementById("message");

            // Check if already authenticated
            checkExistingAuth();

            loginForm.addEventListener("submit", async (e) => {
                e.preventDefault();
                await handleLogin();
            });

            async function checkExistingAuth() {
                try {
                    const token = localStorage.getItem("adminToken");
                    if (!token) return;

                    const response = await fetch(`${API_BASE}/auth/verify`, {
                        headers: { Authorization: `Bearer ${token}` },
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.authenticated && data.isAdmin) {
                            showMessage(
                                "Ya tienes una sesión activa. Redirigiendo...",
                                "success",
                            );
                            setTimeout(() => {
                                window.location.href = "/";
                            }, 1500);
                        }
                    }
                } catch (error) {
                    console.error("Error checking existing auth:", error);
                }
            }

            async function handleLogin() {
                const username = document
                    .getElementById("username")
                    .value.trim();
                const password = document.getElementById("password").value;

                if (!username || !password) {
                    showMessage(
                        "Por favor, complete todos los campos",
                        "error",
                    );
                    return;
                }

                setLoading(true);
                hideMessage();

                try {
                    const response = await fetch(`${API_BASE}/auth/login`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({ username, password }),
                    });

                    const data = await response.json();

                    if (data.success && data.token) {
                        localStorage.setItem("adminToken", data.token);

                        showMessage(
                            "¡Inicio de sesión exitoso! Redirigiendo...",
                            "success",
                        );

                        // Emit event for other components
                        window.dispatchEvent(
                            new CustomEvent("adminLoginSuccess", {
                                detail: {
                                    token: data.token,
                                    username: username,
                                    isAdmin: true,
                                },
                            }),
                        );

                        setTimeout(() => {
                            window.location.href = "/";
                        }, 1500);
                    } else {
                        showMessage(
                            data.error || "Credenciales incorrectas",
                            "error",
                        );
                    }
                } catch (error) {
                    console.error("Login error:", error);
                    showMessage(
                        "Error de conexión. Por favor, inténtelo de nuevo.",
                        "error",
                    );
                } finally {
                    setLoading(false);
                }
            }

            function showMessage(text, type) {
                messageDiv.textContent = text;
                messageDiv.className = `message ${type}`;
                messageDiv.classList.remove("hidden");

                if (type === "error") {
                    setTimeout(() => {
                        hideMessage();
                    }, 5000);
                }
            }

            function hideMessage() {
                messageDiv.classList.add("hidden");
            }

            function setLoading(loading) {
                loginButton.disabled = loading;

                if (loading) {
                    loginButton.innerHTML =
                        '<span class="loading-spinner"></span> Iniciando sesión...';
                    loginButton.classList.add("opacity-75");
                } else {
                    loginButton.innerHTML = "Iniciar Sesión";
                    loginButton.classList.remove("opacity-75");
                }
            }

            // Handle Enter key
            document.addEventListener("keydown", (e) => {
                if (e.key === "Enter" && !loginButton.disabled) {
                    loginForm.dispatchEvent(new Event("submit"));
                }
            });
        });
    </script>
</BaseLayout>
