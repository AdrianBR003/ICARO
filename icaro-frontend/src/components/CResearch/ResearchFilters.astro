---
interface ProjectFilter {
  id: string;
  title: string;
}

interface Props {
  tags: string[];
  projects: ProjectFilter[];
  activeTag: string;
  activeProject: string;
  baseUrl: string;
}

const { tags, projects, activeTag, activeProject, baseUrl } = Astro.props;

function getFilterUrl(param: "tag" | "project", value: string) {
  const url = new URL(baseUrl, "http://dummy.com");

  const currentValue = param === "tag" ? activeTag : activeProject;

  if (currentValue === value) {
    url.searchParams.delete(param); // Desactivar
  } else {
    url.searchParams.set(param, value); // Activar nuevo
    url.searchParams.delete("page"); // Resetear paginación al filtrar
  }

  // 2. Mantener el filtro contrario si existe
  if (param === "tag" && activeProject)
    url.searchParams.set("projectId", activeProject);
  if (param === "project" && activeTag) url.searchParams.set("tag", activeTag);

  // 3. Mantener la búsqueda de texto si existe
  const currentQuery = Astro.url.searchParams.get("query");
  if (currentQuery) url.searchParams.set("query", currentQuery);

  return url.pathname + url.search;
}

// URL para limpiar todo
const clearUrl = baseUrl;
const hasActiveFilters = activeTag || activeProject;
---

<div class="bg-white border border-gray-200 rounded-lg p-5 mb-6 shadow-sm">
  <div class="flex justify-between items-center mb-4">
    <h3
      class="text-xs font-bold text-gray-400 uppercase tracking-wider flex items-center gap-2"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-4 w-4"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"
        ></path>
      </svg>
      Filtros Activos
    </h3>
  </div>

  <div class="mb-4">
    <span class="block text-xs font-semibold text-gray-500 mb-2"
      >Por Etiqueta:</span
    >
    <div class="flex flex-wrap gap-2">
      {
        tags.length > 0 ? (
          tags.map((tag) => {
            const isActive = activeTag === tag;
            return (
              <a
                href={getFilterUrl("tag", tag)}
                class:list={[
                  "px-3 py-1.5 text-sm rounded-md border transition-all duration-200 select-none",
                  isActive
                    ? "bg-[#3b4f6b] text-white border-[#3b4f6b] shadow-md transform scale-105"
                    : "bg-gray-50 text-gray-600 border-gray-200 hover:bg-white hover:border-[#1e293b] hover:text-[#1e293b]",
                ]}
              >
                {tag}
              </a>
            );
          })
        ) : (
          <span class="text-sm text-gray-400 italic">
            No hay etiquetas disponibles.
          </span>
        )
      }
    </div>
  </div>

  <hr class="border-gray-100 my-4 border-dashed" />

  <div>
    <span class="block text-xs font-semibold text-gray-500 mb-2"
      >Por Proyecto Vinculado:</span
    >
    <div class="flex flex-wrap gap-2">
      {
        projects.length > 0 ? (
          projects.map((proj) => {
            const isActive = activeProject === String(proj.id);
            return (
              <a
                href={getFilterUrl("project", String(proj.id))}
                class:list={[
                  "px-3 py-1.5 text-sm rounded-md border transition-all duration-200 flex items-center gap-2 select-none",
                  isActive
                    ? "bg-[#006D38] text-white border-[#006D38] shadow-md transform scale-105"
                    : "bg-gray-50 text-gray-600 border-gray-200 hover:bg-white hover:border-green-400 hover:text-[#006D38]",
                ]}
                title={proj.title}
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class:list={[
                    "h-3 w-3",
                    isActive ? "text-white" : "text-gray-400",
                  ]}
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"
                  />
                </svg>
                <span class="truncate max-w-[200px]">{proj.title}</span>
              </a>
            );
          })
        ) : (
          <span class="text-sm text-gray-400 italic">
            No hay proyectos disponibles.
          </span>
        )
      }
    </div>
  </div>
</div>
