---
const { researchGroups, isAdmin = false } = Astro.props;
let currentWorkData = null;
---
<div class="space-y-8" id="publications">
  {
    researchGroups.map(({ year, items }) =>
      items.map((work) => (
        <article
          class="publication-entry border rounded-lg p-6 shadow-sm bg-white transition-all duration-300 hover:shadow-md relative"
          data-tags={work.tags.join(",")}
          data-project-name={work.projectName || ""}
          data-year={year}
          data-work={JSON.stringify(work)}
        >
          <div class="absolute top-3 right-3 mr-2 flex flex-col gap-2">
            <button
              class={`edit-btn ${isAdmin ? '' : 'hidden'} z-10 p-2 rounded-full bg-white/90 hover:bg-gray-100 transition-colors shadow-sm`}
              data-id={work.id}
              aria-label="Editar"
              onclick={`window.showResearchModal(${JSON.stringify(work)})`}
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5 text-gray-600"
                viewBox="0 0 20 20"
                fill="currentColor"
              >
                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
              </svg>
            </button>
            <button
              class={`edit-btn delete-btn ${isAdmin ? '' : 'hidden'} z-10 p-2 rounded-full bg-white/90 hover:bg-red-100 transition-colors shadow-sm`}
              data-putcode={work.putCode}
              data-title={work.title}
              aria-label="Eliminar"
              onclick={`window.deleteResearchPublication('${work.putCode}', '${work.title.replace(/'/g, "\\'")}')`}
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5 text-gray-600"
                viewBox="0 0 20 20"
                fill="currentColor"
              >
                <path
                  fill-rule="evenodd"
                  d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"
                  clip-rule="evenodd"
                />
              </svg>
            </button>
          </div>
          <div class="flex flex-wrap gap-2 mb-3">
            {work.tags.map((tag) => (
              <span class="bg-gray-50 text-gray-800 text-xs px-2 py-1 rounded font-medium border border-gray-200 shadow-sm">
                {tag}
              </span>
            ))}
            {work.projectName && work.projectName.trim() !== "" && (
              <span class="bg-[#effdf5] text-[#1D293D] text-xs px-2 py-1 rounded font-medium border border-[#BFE5D1] shadow-sm">
                {work.projectName}
              </span>
            )}
          </div>
          <h3 class="text-xl font-bold text-gray-900 leading-snug mb-2">
            {work.title}
          </h3>
          {work.participants?.length > 0 && (
            <p class="text-sm text-gray-700 mb-1">
              {work.participants.join(", ")}
            </p>
          )}
          {work.externalIds?.length > 0 && (
            <p class="text-sm italic text-gray-600">
              DOI: {work.externalIds[0]}
            </p>
          )}
          <p class="text-sm italic text-gray-600">Publicado en: {year}</p>
          <button
            class="mt-4 bg-gray-100 text-gray-800 text-xs px-3 py-1 rounded hover:bg-gray-200 transition"
            type="button"
          >
            BibTeX
          </button>
        </article>
      )),
    )
  }
</div>

<!-- Modal de edición integrado -->
<div
  id="research-modal"
  class="modal hidden fixed inset-0 z-50 flex items-center justify-center p-4 fade-in"
>
  <div
    class="modal-overlay absolute inset-0 bg-black/50"
    onclick="window.hideResearchModal()"
  ></div>

  <div
    class="relative bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto"
  >
    <div class="p-6">   
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold">Editar Publicación</h3>
        <button
          type="button"
          onclick="window.hideResearchModal()"
          class="text-gray-500 hover:text-gray-700"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <form id="research-form" class="space-y-4">
        <input type="hidden" id="putCode" name="putCode" />
        
        <div>
          <label class="block mb-1 text-sm font-medium">Título *</label>
          <input
            type="text"
            id="title"
            name="title"
            required
            class="w-full px-3 py-2 border rounded-md"
          />
        </div>

        <div>
          <label class="block mb-1 text-sm font-medium">Descripción</label>
          <textarea
            id="description"
            name="description"
            rows="3"
            class="w-full px-3 py-2 border rounded-md"
          ></textarea>
        </div>

        <div>
          <label class="block mb-1 text-sm font-medium">Participantes (separados por coma)</label>
          <textarea
            id="participants"
            name="participants"
            rows="2"
            class="w-full px-3 py-2 border rounded-md"
            placeholder="Autor1, Autor2, Autor3"
          ></textarea>
        </div>

        <div>
          <label class="block mb-1 text-sm font-medium">IDs Externos (DOI, separados por coma)</label>
          <input
            type="text"
            id="externalIds"
            name="externalIds"
            class="w-full px-3 py-2 border rounded-md"
            placeholder="10.1109/ACCESS.2024.3411307"
          />
        </div>

        <div>
          <label class="block mb-1 text-sm font-medium">ORCID Propietarios (separados por coma)</label>
          <input
            type="text"
            id="ownerOrcids"
            name="ownerOrcids"
            class="w-full px-3 py-2 border rounded-md"
            placeholder="0000-0001-9518-8955"
          />
        </div>

        <div>
          <label class="block mb-1 text-sm font-medium">Fecha del Proyecto *</label>
          <input
            type="date"
            id="projectDate"
            name="projectDate"
            required
            class="w-full px-3 py-2 border rounded-md"
          />
        </div>

        <div>
          <label class="block mb-1 text-sm font-medium">Titulo del Proyecto</label>
          <input
            type="text"
            id="projectId"
            name="projectId"
            class="w-full px-3 py-2 border rounded-md"
            placeholder="PRJ-001"
          />
        </div>

        <div>
          <label class="block mb-1 text-sm font-medium">Etiquetas (separadas por coma)</label>
          <input
            type="text"
            id="tags"
            name="tags"
            class="w-full px-3 py-2 border rounded-md"
            placeholder="journal-article, conference-paper"
          />
        </div>

        <div class="flex gap-4 pt-4 border-t">
          <button
            type="button"
            onclick="window.hideResearchModal()"
            class="px-4 py-2 border rounded-md hover:bg-gray-50"
          >
            Cancelar
          </button>
          <button
            type="submit"
            class="px-4 py-2 bg-[#006D38] text-white rounded-md hover:bg-[#005229]"
          >
            Guardar
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script is:inline>
  // Funciones globales para manejar el modal
  window.showResearchModal = function(workData) {
    fillResearchForm(workData);
    document.getElementById('research-modal')?.classList.remove('hidden');
  };

  window.hideResearchModal = function() {
    document.getElementById('research-modal')?.classList.add('hidden');
  };

  window.deleteResearchPublication = function(putCode, title) {
    if (!putCode) {
      alert("No se proporcionó un Put Code válido.");
      return;
    }

    const confirmDelete = confirm(
      `¿Estás seguro de que deseas eliminar la publicación "${title}"? Esta acción no se puede deshacer.`,
    );
    if (!confirmDelete) return;

    fetch(
      `http://localhost:8080/api/works/delete/${putCode}`,
      {
        method: "DELETE",
        credentials: "include",
      },
    )
    .then(response => {
      if (response.ok) {
        alert("Publicación eliminada correctamente");
        window.location.reload();
      } else {
        return response.text().then(errorText => {
          throw new Error(`Error ${response.status}: ${errorText}`);
        });
      }
    })
    .catch(error => {
      console.error("Error al eliminar la publicación:", error);
      alert("Error al eliminar la publicación: " + error.message);
    });
  };

  function fillResearchForm(workData) {
    document.getElementById("putCode").value = workData.putCode || "";
    document.getElementById("title").value = workData.title || "";
    document.getElementById("description").value = workData.description || "";
    document.getElementById("participants").value = workData.participants
      ? workData.participants.join(", ")
      : "";
    document.getElementById("externalIds").value = workData.externalIds
      ? workData.externalIds.join(", ")
      : "";
    document.getElementById("ownerOrcids").value = workData.ownerOrcids
      ? workData.ownerOrcids.join(", ")
      : "";
    document.getElementById("projectDate").value = workData.projectDate || "";
    document.getElementById("projectId").value = workData.projectName || "";
    document.getElementById("tags").value = workData.tags
      ? workData.tags.join(", ")
      : "";
  }

  document.getElementById("research-form")?.addEventListener("submit", async function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const workData = {};

    workData.putCode = formData.get("putCode") || null;
    workData.title = formData.get("title");
    workData.description = formData.get("description") || null;
    workData.participants = formData.get("participants")
      ? formData
          .get("participants")
          .split(",")
          .map((p) => p.trim())
          .filter((p) => p)
      : [];
    workData.externalIds = formData.get("externalIds")
      ? formData
          .get("externalIds")
          .split(",")
          .map((id) => id.trim())
          .filter((id) => id)
      : [];
    workData.ownerOrcids = formData.get("ownerOrcids")
      ? formData
          .get("ownerOrcids")
          .split(",")
          .map((orcid) => orcid.trim())
          .filter((orcid) => orcid)
      : [];
    workData.projectDate = formData.get("projectDate");
    workData.projectId = formData.get("projectId") || null;
    workData.tags = formData.get("tags")
      ? formData
          .get("tags")
          .split(",")
          .map((tag) => tag.trim())
          .filter((tag) => tag)
      : [];

    try {
      const response = await fetch("http://localhost:8080/api/works/save", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        credentials: "include",
        body: JSON.stringify(workData),
      });

      if (response.ok) {
        alert(
          workData.putCode
            ? "Publicación actualizada correctamente"
            : "Publicación creada correctamente",
        );
        window.hideResearchModal();
        window.location.reload();
      } else {
        const errorText = await response.text();
        throw new Error(`Error ${response.status}: ${errorText}`);
      }
    } catch (error) {
      console.error("Error al guardar:", error);
      alert("Error al guardar los cambios: " + error.message);
    }
  });
</script>

<style>
  .publication-entry {
    transition: box-shadow 0.3s ease;
  }


  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }
</style>