---
import type { ResearchWorkDTO } from "@/types/research";

interface Props {
  work: ResearchWorkDTO;
  isAdmin?: boolean;
}

const { work } = Astro.props;
const cardId = `research-card-${work.id}`;

// Serializamos para el botón de editar
const workJson = JSON.stringify(work);

// Formateo de fecha
function formatDate(dateString: string): string {
  if (!dateString) return "Fecha desconocida";
  const date = new Date(dateString);
  return isNaN(date.getTime())
    ? dateString
    : date.toLocaleDateString("es-ES", {
        year: "numeric",
        month: "long",
        day: "numeric",
      });
}

const formattedDate = formatDate(work.projectDate);
---

<div
  id={cardId}
  class="research-card relative bg-white border rounded-lg p-6 shadow-sm transition-all duration-300 hover:shadow-md group"
  data-research-id={work.id}
>
  <div
    class="absolute top-3 right-3 flex flex-col gap-2 admin-control hidden z-20"
  >
    <button
      type="button"
      class="edit-btn p-2 rounded-full bg-white/90 hover:bg-gray-100 transition-colors shadow-sm border border-gray-200"
      data-entity-data={workJson}
      title="Editar Publicación"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-5 w-5 text-gray-600"
        viewBox="0 0 20 20"
        fill="currentColor"
      >
        <path
          d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"
        ></path>
      </svg>
    </button>

    <button
      type="button"
      class="delete-btn p-2 rounded-full bg-white/90 hover:bg-red-100 transition-colors shadow-sm border border-gray-200"
      data-entity-id={work.id}
      data-entity-title={work.title}
      title="Eliminar Publicación"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-5 w-5 text-gray-600"
        viewBox="0 0 20 20"
        fill="currentColor"
      >
        <path
          fill-rule="evenodd"
          d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"
          clip-rule="evenodd"></path>
      </svg>
    </button>
  </div>

  <div class="pr-10">
    <div class="flex flex-wrap items-center mb-3 gap-2">
       <span
        class="bg-[#1D293D] text-white text-xs px-3 py-1 rounded-full font-medium"
      >
        {formattedDate}
      </span>
      {
        work.projectTitle && (
          <span class="inline-flex items-center gap-1 px-3 py-1 rounded-md text-xs font-bold bg-indigo-50 text-green-700 border border-indigo-100">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-3 w-3"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"
              />
            </svg>
            {work.projectTitle}
          </span>
        )
      }
      {
        work.tags &&
          work.tags.map((tag) => (
            <span class="bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded-full border border-gray-200">
              {tag}
            </span>
          ))
      }
    </div>

    <h3 class="text-xl font-bold text-gray-900 mb-2 leading-tight">
      {work.title}
    </h3>

    <p class="text-gray-600 mb-4 line-clamp-3 text-sm leading-relaxed">
      {work.description}
    </p>

    {
      work.participants && work.participants.length > 0 && (
        <div class="mb-4">
          <h4 class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">
            Autores
          </h4>
          <p class="text-sm text-gray-700 font-medium">
            {work.participants.join(", ")}
          </p>
        </div>
      )
    }

    {
      work.externalIds && work.externalIds.length > 0 && (
        <div class="flex flex-wrap gap-3 mt-4 pt-3 border-t border-gray-100">
          {work.externalIds.map((link) => (
            <a
              href={link.startsWith("http") ? link : `https://${link}`}
              target="_blank"
              rel="noopener noreferrer"
              class="text-sm font-medium text-[#006D38] hover:underline flex items-center gap-1 group/link"
            >
              Ver Recurso
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-3 w-3 transition-transform group-hover/link:translate-x-0.5"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
                />
              </svg>
            </a>
          ))}
        </div>
      )
    }
  </div>
</div>
