---
export interface Props {
  project: {
    id: string;
    title: string;
    description: string;
    colaborators: string[];
    firstprojectDate: string; 
    secondprojectDate: string;
    [key: string]: any;
  };
  isAdmin?: boolean;
}

const { project, isAdmin = false } = Astro.props;
const cardId = `project-card-${project.id}`;
const modalId = `edit-project-modal-${project.id}`;
const editBtnId = `edit-btn-${project.id}`;
---

<!-- Bot√≥n de editar -->
<button
  id={editBtnId}
  class={`edit-btn ${isAdmin ? 'flex' : 'hidden'} absolute top-3 right-3 z-10 p-2 rounded-full bg-white/90 hover:bg-gray-100 transition-colors shadow-sm`}
  data-project-id={project.id}
  data-card-id={cardId}
  aria-label="Editar proyecto"
  type="button"
>
  <svg
    xmlns="http://www.w3.org/2000/svg"
    class="h-5 w-5 text-gray-600"
    viewBox="0 0 20 20"
    fill="currentColor"
  >
    <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
  </svg>
</button>

<!-- Modal de edici√≥n -->
<div
  id={modalId}
  class="modal hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50"
>
  <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
    <div class="p-6">   
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold">Editar Proyecto</h3>
        <button
          type="button"
          class="close-modal text-gray-500 hover:text-gray-700"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <form class="project-edit-form space-y-4">
        <input type="hidden" name="projectId" value={project.id} />

        <div>
          <label class="block mb-1 text-sm font-medium">T√≠tulo del Proyecto *</label>
          <input 
            type="text" 
            name="title" 
            value={project.title} 
            required 
            class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-[#006D38] focus:border-transparent" 
          />
        </div>

        <div>
          <label class="block mb-1 text-sm font-medium">Descripci√≥n *</label>
          <textarea 
            name="description" 
            rows="3" 
            required
            class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-[#006D38] focus:border-transparent"
          >{project.description || ""}</textarea>
        </div>

        <div>
          <label class="block mb-1 text-sm font-medium">Colaboradores</label>
          <textarea 
            name="colaborators" 
            rows="2" 
            class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-[#006D38] focus:border-transparent"
            placeholder="Colaborador1, Colaborador2, Colaborador3"
          >{project.colaborators?.join(", ") || ""}</textarea>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block mb-1 text-sm font-medium">Primera Fecha del Proyecto</label>
            <input 
              type="date" 
              name="firstprojectDate" 
              value={project.firstprojectDate || ""} 
              class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-[#006D38] focus:border-transparent" 
            />
          </div>

          <div>
            <label class="block mb-1 text-sm font-medium">Segunda Fecha del Proyecto</label>
            <input 
              type="date" 
              name="secondprojectDate" 
              value={project.secondprojectDate || ""} 
              class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-[#006D38] focus:border-transparent" 
            />
          </div>
        </div>

        <div class="flex gap-4 pt-4 border-t">
          <button
            type="button"
            class="cancel-btn px-4 py-2 border rounded-md hover:bg-gray-50 transition-colors"
          >
            Cancelar
          </button>
          <button
            type="submit"
            class="px-4 py-2 bg-[#006D38] text-white rounded-md hover:bg-[#005229] transition-colors"
          >
            Guardar Cambios
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script is:inline define:vars={{ modalId, editBtnId, project, isAdmin }}>
  function initializeProjectEditComponent() {
    
    // ============= SISTEMA DE AUTENTICACI√ìN JWT =============

    // Helper para generar headers con token JWT
    function getAuthHeaders() {
      const token = localStorage.getItem('adminToken');
      
      const headers = {
        'Content-Type': 'application/json'
      };
      
      // Si existe token, a√±adir header Authorization con Bearer
      if (token) {
        headers['Authorization'] = `Bearer ${token}`;
      }
      
      return headers;
    }

    // Funci√≥n para manejar errores de autenticaci√≥n
    function handleAuthError(response) {
      if (response.status === 401 || response.status === 403) {
        alert('No tiene permisos para realizar esta acci√≥n. Por favor, inicie sesi√≥n como administrador.');
        localStorage.removeItem('adminToken');
        // Opcional: redirigir al login
        // window.location.href = '/admin-login';
        return true;
      }
      return false;
    }

    // Verificar si el usuario tiene permisos de admin
    async function verifyAdminPermissions() {
      try {
        const token = localStorage.getItem('adminToken');
        if (!token) {
          return false;
        }

        const response = await fetch('http://localhost:8080/api/auth/verify', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const data = await response.json();
          return data.authenticated && data.isAdmin;
        } else {
          localStorage.removeItem('adminToken');
          return false;
        }
      } catch (error) {
        console.error('‚ùå [EDIT-PROJECT] Error verificando permisos:', error);
        return false;
      }
    }

    // ============= L√ìGICA DEL MODAL Y FORMULARIO =============

    // Buscar el bot√≥n directamente por su ID √∫nico
    const editBtn = document.getElementById(editBtnId);
    const modal = document.getElementById(modalId);
    
    if (!editBtn || !modal) {
      console.warn('‚ùå [EDIT-PROJECT] No se encontraron elementos necesarios:', { editBtn: !!editBtn, modal: !!modal });
      return;
    }

    const form = modal.querySelector('.project-edit-form');
    const closeBtn = modal.querySelector('.close-modal');
    const cancelBtn = modal.querySelector('.cancel-btn');

    if (!form) {
      console.warn('‚ùå [EDIT-PROJECT] No se encontr√≥ el formulario');
      return;
    }

    // Funci√≥n para abrir el modal
    async function openModal() {
      console.log('‚úèÔ∏è [EDIT-PROJECT] Intentando abrir modal de edici√≥n');
      
      // Verificar permisos antes de abrir el modal
      const hasPermissions = await verifyAdminPermissions();
      if (!hasPermissions) {
        alert('Debe iniciar sesi√≥n como administrador para realizar esta acci√≥n.');
        return;
      }

      console.log('‚úÖ [EDIT-PROJECT] Permisos verificados, abriendo modal');
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    // Funci√≥n para cerrar el modal
    function closeModal() {
      modal.classList.add('hidden');
      document.body.style.overflow = '';
      console.log('‚ùå [EDIT-PROJECT] Modal cerrado');
    }

    // Event listeners
    editBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      console.log('‚úèÔ∏è [EDIT-PROJECT] Bot√≥n de editar clickeado');
      openModal();
    });

    if (closeBtn) {
      closeBtn.addEventListener('click', closeModal);
    }

    if (cancelBtn) {
      cancelBtn.addEventListener('click', closeModal);
    }

    // Cerrar modal al hacer click fuera
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        closeModal();
      }
    });

    // Cerrar con ESC
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
        closeModal();
      }
    });

    // Manejar env√≠o del formulario
    form.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      console.log('‚úèÔ∏è [EDIT-PROJECT] Intentando actualizar proyecto:', project.id);
      
      // Verificar permisos antes de procesar
      const hasPermissions = await verifyAdminPermissions();
      if (!hasPermissions) {
        alert('Debe iniciar sesi√≥n como administrador para realizar esta acci√≥n.');
        return;
      }
      
      if (!confirm("¬øEst√°s seguro de que deseas guardar los cambios?")) {
        return;
      }
      
      const formData = new FormData(form);
      const projectData = {
        id: formData.get("projectId"),
        title: formData.get("title"),
        description: formData.get("description"),
        participants: formData.get("colaborators") ? 
          formData.get("colaborators").split(",").map(item => item.trim()).filter(Boolean) : [],
        firstprojectDate: formData.get("firstprojectDate") || null,
        secondprojectDate: formData.get("secondprojectDate") || null
      };

      try {
        console.log('üì§ [EDIT-PROJECT] Enviando datos de actualizaci√≥n:', projectData);
        console.log('üîê [EDIT-PROJECT] Headers que se van a enviar:', getAuthHeaders());

        const response = await fetch("http://localhost:8080/api/project/update", {
          method: "POST",
          headers: getAuthHeaders(), // Usar headers con JWT en lugar de credentials
          body: JSON.stringify(projectData)
        });

        console.log('üîê [EDIT-PROJECT] Respuesta del servidor:', response.status);

        if (response.ok) {
          alert("El proyecto se actualiz√≥ correctamente.");
          closeModal();
          console.log('‚úÖ [EDIT-PROJECT] Proyecto actualizado exitosamente');
          window.location.reload();
        } else if (handleAuthError(response)) {
          return;
        } else {
          let errorMessage = 'Error desconocido';
          
          // Manejo espec√≠fico de errores comunes
          if (response.status === 404) {
            errorMessage = 'El proyecto no existe o no se pudo encontrar.';
          } else if (response.status === 409) {
            errorMessage = 'Conflicto al actualizar el proyecto. Verifique los datos.';
          } else if (response.status === 400) {
            errorMessage = 'Datos inv√°lidos. Verifique que todos los campos est√©n correctos.';
          } else if (response.status === 500) {
            errorMessage = 'Error interno del servidor. Intente nuevamente m√°s tarde.';
          } else {
            try {
              // Intentar leer como texto primero (m√°s compatible)
              const responseText = await response.text();
              
              // Si el texto parece ser JSON, intentar parsearlo
              if (responseText.startsWith('{') || responseText.startsWith('[')) {
                try {
                  const errorData = JSON.parse(responseText);
                  errorMessage = errorData.message || errorData.error || responseText;
                } catch {
                  errorMessage = responseText;
                }
              } else {
                errorMessage = responseText || `Error ${response.status}: ${response.statusText}`;
              }
            } catch (error) {
              errorMessage = `Error ${response.status}: ${response.statusText}`;
            }
          }
          
          console.error('‚ùå [EDIT-PROJECT] Error del backend:', errorMessage);
          alert("Error al actualizar el proyecto: " + errorMessage);
        }
      } catch (error) {
        console.error('‚ùå [EDIT-PROJECT] Error de conexi√≥n:', error);
        alert("Error de conexi√≥n al actualizar el proyecto: " + error.message);
      }
    });

    console.log('‚úÖ [EDIT-PROJECT] ProjectEdit inicializado correctamente para:', project.id);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeProjectEditComponent);
  } else {
    setTimeout(initializeProjectEditComponent, 50);
  }
</script>

<style>
  .modal {
    transition: opacity 0.3s ease;
  }
  .modal.hidden {
    opacity: 0;
    pointer-events: none;
  }
  .modal:not(.hidden) {
    opacity: 1;
    pointer-events: all;
  }
</style>