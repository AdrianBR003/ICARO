---
import NewsCard from "@/components/CNews/CCNewsList/NewsCard.astro";
import NewsAdd from "@/components/CNews/NewsAdd.astro";
import NewsEdit from "@/components/CNews/CCNewsList/NewsEdit.astro";
import NewsDelete from "@/components/CNews/CCNewsList/NewsDelete.astro";
import type { News } from "@/types/news";
import SearchFilter from "../CCommon/SearchFilter.astro";

interface Props {
  news: News[];
}

const { news } = Astro.props;
---

<div id="news-list-container">
  <NewsAdd />

  <div class="w-full max-w-custom mb-3 relative">
    <SearchFilter
      inputId="news-search"
      placeholder="Buscar noticias por título o descripción..."
    />
    <!-- Las sugerencias se inyectarán aquí dinámicamente -->
  </div>

  <!-- Lista de noticias con data-news-id para identificación -->
  <div class="space-y-6" id="news-list">
    {
      news.map((newsItem) => (
        <article class="news-card-item" data-news-id={newsItem.id}>
          <NewsCard news={newsItem} />
        </article>
      ))
    }
    {news.length === 0 && (
      <p class="text-gray-500">No hay noticias disponibles.</p>
    )}
  </div>

  <!-- Mensaje cuando no hay resultados -->
  <p id="no-news-results" style="display: none;">
    No se encontraron resultados.
  </p>

  <NewsEdit />
  <NewsDelete />

  <script>
    import { createImageLoader } from "@/utils/imageLoaderFactory";
    import { setupAdvancedSearch } from "@/utils/searchFilter";

    document.addEventListener("DOMContentLoaded", function () {
      // Cargar imágenes de las noticias
      const newsImageLoader = createImageLoader({
        basePath: "http://localhost:8080/assets/news",
        dataAttribute: "data-news-image",
      });

      newsImageLoader.loadImages();
      newsImageLoader.setupObserver("news-list");

      // Configurar búsqueda avanzada con sugerencias y navegación
      setupAdvancedSearch({
        inputId: "news-search", // ID del input de búsqueda
        containerId: "news-list", // Contenedor de las noticias
        itemSelector: ".news-card-item", // Selector de cada tarjeta
        titleSelector: "h3", // Selector del título dentro de la tarjeta
        descriptionSelector: ".text-gray-600", // Selector de la descripción
        noResultsId: "no-news-results", // Elemento para mensajes
        searchEndpoint: "http://localhost:8080/api/news/search", // Endpoint de búsqueda en backend
        baseUrl: window.location.pathname, // URL base para navegación
        debounceMs: 500, // Esperar 500ms antes de buscar en backend
      });
    });
  </script>

  <style>
    .relative {
      position: relative;
    }

    #no-news-results {
      text-align: center;
      padding: 2rem;
      color: #64748b;
      font-size: 0.875rem;
      background: #f8fafc;
      border-radius: 0.5rem;
      border: 1px dashed #cbd5e1;
      margin-top: 1rem;
    }
  </style>
</div>