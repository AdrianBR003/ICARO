---
import NewsCard from "@/components/CNews/NewsCard.astro";
import NewsAdd from "@/components/CNews/modals/NewsAdd.astro";
import NewsEdit from "@/components/CNews/modals/NewsEdit.astro";
import NewsDelete from "@/components/CNews/modals/NewsDelete.astro";
import SearchFilter from "@/components/CCommon/SearchFilter.astro";
import Loader from "@/components/CCommon/Loader.astro"; 
import type { News } from "@/types/news";

interface Props {
  news: News[];
  serverError?: boolean; // Hacemos esta prop opcional
}

const { news, serverError = false } = Astro.props;
const hasQuery = Astro.url.searchParams.has("query");
const hasNews = news.length > 0;

// Lógica de mensaje inicial robusta
let initialLoaderText = "";

if (serverError) {
  // CASO 1: Falló el backend en SSR
  initialLoaderText = "El servidor no responde temporalmente.";
} else if (!hasNews) {
  // CASO 2: Todo bien, pero no hay datos
  initialLoaderText = hasQuery 
    ? "No se encontraron resultados" 
    : "No hay noticias disponibles";
}
---

<div id="news-page-wrapper" class="flex flex-col gap-4"> 
  
  <NewsAdd />

  <div class="w-full max-w-custom relative z-[60]">
    <SearchFilter
      inputId="news-search"
      placeholder="Buscar noticias por título o descripción..."
      baseURL={Astro.url.pathname}
    />
  </div>

  <div class="relative min-h-[400px]">
    
    <div id="news-list-loader-wrapper" class={hasNews ? "hidden" : ""}>
        <Loader 
          id="news-list-loader" 
          text={initialLoaderText}
        />
    </div>

    <div id="content-area" class="transition-opacity duration-300">
      {
        hasNews && (
          <div id="news-list-container" class="space-y-4">
             {news.map((newsItem) => (
               <article class="news-card-item" data-news-id={newsItem.id}>
                 <NewsCard news={newsItem} />
               </article>
             ))}
          </div>
        )
      }
    </div>

  </div> 

  <NewsEdit />
  <NewsDelete />

</div>

<script>
  import { initNewsList } from "@/utils/news/newsListUtils";
  document.addEventListener("DOMContentLoaded", () => {
    initNewsList();
  });
</script>

<style>
  .space-y-4 > * + * { margin-top: 1rem; }
  .max-w-custom { max-width: 1200px; }
</style>