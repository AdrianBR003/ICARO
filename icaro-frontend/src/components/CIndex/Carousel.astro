---
import CarouselCard from "@/components/CIndex/CarouselCard.astro";
import Loader from "@/components/CCommon/Loader.astro";
import { fetchHighlightedNews } from "@/services/index/carouselService";
import type { News } from "@/types/news";

// 1. Fetch de datos en el SERVIDOR (Build time o SSR)
let newsList: News[] = [];
let error = false;

try {
  newsList = await fetchHighlightedNews();
} catch (e) {
  console.error("Error fetching news in SSR:", e);
  error = true;
}
---

<div class="w-full mx-auto relative group">
  <div
    class="grid grid-cols-[auto_1fr_auto] gap-2 sm:gap-4 md:gap-6 lg:gap-8 items-center"
  >
    <button
      id="prevBtn"
      aria-label="Anterior"
      type="button"
      class="hidden sm:flex w-10 h-10 md:w-12 md:h-12 lg:w-14 lg:h-14 items-center justify-center bg-white/80 backdrop-blur rounded-full shadow-md border border-gray-100 text-gray-700 hover:bg-[#1D293D] hover:text-white hover:border-[#1D293D] transition-all duration-300 z-10 focus:outline-none focus:ring-2 focus:ring-[#1D293D]/50"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-6 w-6"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M15 19l-7-7 7-7"></path>
      </svg>
    </button>

    <div
      id="slider"
      class="relative flex gap-0 overflow-x-auto no-scrollbar scroll-smooth snap-x snap-mandatory w-full rounded-xl items-center"
    >
      {
        newsList.length > 0 ? (
          newsList.map((news) => <CarouselCard news={news} />)
        ) : (
          /* CASO 2: NO HAY DATOS O ERROR */
          <div id="empty-state" class="w-full text-center py-10">
            {error ? (
              <p class="text-red-500">No se pudo conectar con el servidor.</p>
            ) : (
              <p class="text-gray-500">No hay noticias destacadas.</p>
            )}
          </div>
        )
      }

      <div
        id="carousel-loader"
        class="hidden absolute inset-0 bg-white/50 z-20 flex items-center justify-center"
      >
        <Loader id="carousel-loader-inner" text="Actualizando..." />
      </div>
    </div>

    <button
      id="nextBtn"
      aria-label="Siguiente"
      type="button"
      class="hidden sm:flex w-10 h-10 md:w-12 md:h-12 lg:w-14 lg:h-14 items-center justify-center bg-white/80 backdrop-blur rounded-full shadow-md border border-gray-100 text-gray-700 hover:bg-[#1D293D] hover:text-white hover:border-[#1D293D] transition-all duration-300 z-10 focus:outline-none focus:ring-2 focus:ring-[#1D293D]/50"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-6 w-6"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M9 5l7 7-7 7"></path>
      </svg>
    </button>
  </div>
</div>

<script>
  // Importamos SOLO la lÃ³gica de scroll, ya no la de crear HTML
  import { initCarouselScroll } from "@/utils/index/carousel";

  document.addEventListener("DOMContentLoaded", () => {
    initCarouselScroll("slider", "prevBtn", "nextBtn");
  });
</script>

<style>
  .no-scrollbar::-webkit-scrollbar {
    display: none;
  }
  .no-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
</style>
